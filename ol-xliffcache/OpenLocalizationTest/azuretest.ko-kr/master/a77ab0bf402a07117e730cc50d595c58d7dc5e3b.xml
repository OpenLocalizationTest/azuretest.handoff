{
  "nodes": [
    {
      "content": "Connect a Mobile App to an enterprise SaaS | Microsoft Azure",
      "pos": [
        27,
        87
      ]
    },
    {
      "content": "Learn how to make calls to enterprise resources such as SharePoint Online",
      "pos": [
        106,
        179
      ]
    },
    {
      "content": "Connect your mobile app to SaaS APIs",
      "pos": [
        517,
        553
      ]
    },
    {
      "content": "In this tutorial, you will connect your mobile app to an enterprise software-as-a-service (SaaS) solution.",
      "pos": [
        555,
        661
      ]
    },
    {
      "content": "You will update the app from the [Authenticate your app with Azure Active Directory Authentication Library Single Sign-On] to create a Microsoft Word document in SharePoint Online whenever a new TodoItem is added.",
      "pos": [
        662,
        875
      ]
    },
    {
      "content": "This tutorial requires the following:",
      "pos": [
        877,
        914
      ]
    },
    {
      "content": "Visual Studio 2013 running on Windows 8.1",
      "pos": [
        918,
        959
      ]
    },
    {
      "pos": [
        962,
        1004
      ],
      "content": "An active <bpt id=\"p1\">[</bpt><ept id=\"p1\">SharePoint Online]</ept> subscription"
    },
    {
      "content": "Completion of the <bpt id=\"p1\">[</bpt><ept id=\"p1\">Authenticate your app with Active Directory Authentication Library Single Sign-On]</ept> tutorial.",
      "pos": [
        1007,
        1118
      ]
    },
    {
      "content": "You should use the tenant provided by your SharePoint subscription.",
      "pos": [
        1119,
        1186
      ]
    },
    {
      "content": "Configure your application for delegated access to SharePoint",
      "pos": [
        1227,
        1288
      ]
    },
    {
      "content": "By default, the token you receive from AAD has limited permissions.",
      "pos": [
        1289,
        1356
      ]
    },
    {
      "content": "In order to access a third-party resource or SaaS application such as SharePoint Online, you must explicitly allow it.",
      "pos": [
        1357,
        1475
      ]
    },
    {
      "content": "In the <bpt id=\"p1\">**</bpt>Active Directory<ept id=\"p1\">**</ept> Section of the <bpt id=\"p2\">[</bpt><ept id=\"p2\">Azure Management Portal]</ept>, select your tenant.",
      "pos": [
        1480,
        1569
      ]
    },
    {
      "content": "Navigate to the web application that you created for the App Service.",
      "pos": [
        1570,
        1639
      ]
    },
    {
      "content": "In the <bpt id=\"p1\">**</bpt>Configure<ept id=\"p1\">**</ept> tab, scroll the page down to the permissions to other applications section.",
      "pos": [
        1644,
        1740
      ]
    },
    {
      "content": "Select <bpt id=\"p1\">**</bpt>Office 365 SharePoint Online<ept id=\"p1\">**</ept> and grant the <bpt id=\"p2\">**</bpt>Edit or delete users' files<ept id=\"p2\">**</ept> delegated permission.",
      "pos": [
        1741,
        1848
      ]
    },
    {
      "content": "Then click <bpt id=\"p1\">**</bpt>Save<ept id=\"p1\">**</ept>.",
      "pos": [
        1849,
        1869
      ]
    },
    {
      "content": "![][1]",
      "pos": [
        1875,
        1881
      ]
    },
    {
      "content": "You have now configured Azure AD to issue a SharePoint access token to the App Service.",
      "pos": [
        1883,
        1970
      ]
    },
    {
      "content": "Add SharePoint information to your Mobile App",
      "pos": [
        2007,
        2052
      ]
    },
    {
      "content": "In order to make a call to SharePoint, you need to specify the endpoints that the mobile app needs to talk to.",
      "pos": [
        2054,
        2164
      ]
    },
    {
      "content": "You also need to be able to prove the identity of your app service.",
      "pos": [
        2165,
        2232
      ]
    },
    {
      "content": "This is accomplished using a Client ID and Client Secret pair.",
      "pos": [
        2233,
        2295
      ]
    },
    {
      "content": "You have already obtained and stored the Client ID for the app service during the AAD login setup.",
      "pos": [
        2296,
        2394
      ]
    },
    {
      "content": "Because these are sensitive credentials, you should'nt store them as plaintext in our code.",
      "pos": [
        2395,
        2486
      ]
    },
    {
      "content": "Instead, you'll set these values as Application Settings for our Mobile App Code site.",
      "pos": [
        2487,
        2573
      ]
    },
    {
      "content": "Return to the AAD Applications tab for your tenant, and select the web application for your app service.",
      "pos": [
        2578,
        2682
      ]
    },
    {
      "content": "Under Configure, scroll down to Keys.",
      "pos": [
        2687,
        2724
      ]
    },
    {
      "content": "You'll obtain a Client Secret by generating a new key.",
      "pos": [
        2725,
        2779
      ]
    },
    {
      "content": "Note once you create a key and leave the page, there is no way to get it out of the portal again.",
      "pos": [
        2780,
        2877
      ]
    },
    {
      "content": "Upon creation you must copy and save this value in a secure location.",
      "pos": [
        2878,
        2947
      ]
    },
    {
      "content": "Select a duration for your key, then click save, and copy out the resulting value.",
      "pos": [
        2948,
        3030
      ]
    },
    {
      "content": "In the Mobile App Code section of the Management Portal, navigate to the Configure tab, and scroll down to App Settings.",
      "pos": [
        3035,
        3155
      ]
    },
    {
      "content": "Here you can provide a key-value pair to help you reference the necessary credentials.",
      "pos": [
        3156,
        3242
      ]
    },
    {
      "content": "Set SP_Authority to be the authority endpoint for your AAD tenant.",
      "pos": [
        3246,
        3312
      ]
    },
    {
      "content": "This should be the same as the authority value used for your client app.",
      "pos": [
        3313,
        3385
      ]
    },
    {
      "content": "It'll be of the form <ph id=\"ph1\">`https://login.windows.net/contoso.onmicrosoft.com`</ph>",
      "pos": [
        3386,
        3458
      ]
    },
    {
      "content": "Set SP_ClientSecret to be the client secret value you obtained earlier.",
      "pos": [
        3462,
        3533
      ]
    },
    {
      "content": "Set SP_SharePointURL to be the URL for your SharePoint site.",
      "pos": [
        3537,
        3597
      ]
    },
    {
      "content": "It should be of the form <ph id=\"ph1\">`https://contoso-my.sharepoint.com`</ph>",
      "pos": [
        3598,
        3658
      ]
    },
    {
      "content": "You'll be able to obtain these values again in your code using ApiServices.Settings.",
      "pos": [
        3660,
        3744
      ]
    },
    {
      "content": "Obtain an access token and call the SharePoint API",
      "pos": [
        3776,
        3826
      ]
    },
    {
      "content": "In order to access SharePoint, you need a special access token with SharePoint as the target audience.",
      "pos": [
        3828,
        3930
      ]
    },
    {
      "content": "To get this token, you'll need to call back into Azure AD with the identity of the App Service and the token that was issued for the user.",
      "pos": [
        3931,
        4069
      ]
    },
    {
      "content": "Open your Mobile App Code project in Visual Studio.",
      "pos": [
        4074,
        4125
      ]
    },
    {
      "content": "In the NuGet Package manager, click <bpt id=\"p1\">**</bpt>Online<ept id=\"p1\">**</ept>.",
      "pos": [
        4258,
        4305
      ]
    },
    {
      "content": "Enter <bpt id=\"p1\">**</bpt>Microsoft.Azure.Mobile.Server.AppService<ept id=\"p1\">**</ept> as a search term.",
      "pos": [
        4306,
        4374
      ]
    },
    {
      "content": "Then click <bpt id=\"p1\">**</bpt>Install<ept id=\"p1\">**</ept> to install the <bpt id=\"p2\">[</bpt><ept id=\"p2\">Mobile Apps .NET Backend App Service Extension]</ept> package.",
      "pos": [
        4375,
        4470
      ]
    },
    {
      "content": "This package provides extension methods for working with information about the currently logged-in user.",
      "pos": [
        4471,
        4575
      ]
    },
    {
      "content": "In your Mobile App Code project, create a new class called SharePointUploadContext.",
      "pos": [
        4580,
        4663
      ]
    },
    {
      "content": "Add a <ph id=\"ph1\">`using Microsoft.Azure.Mobile.Server.AppService;`</ph> statement to the file.",
      "pos": [
        4664,
        4742
      ]
    },
    {
      "content": "Then, add the following to the class:",
      "pos": [
        4743,
        4780
      ]
    },
    {
      "pos": [
        4790,
        5093
      ],
      "content": "private String accessToken;\n     private String mySiteApiPath;\n     private String clientId;\n     private String clientSecret;\n     private String sharepointURL;\n     private String authority;\n     private const string getFilesPath = \"/getfolderbyserverrelativeurl('Documents')/Files\";",
      "leadings": [
        "",
        "   ",
        "   ",
        "   ",
        "   ",
        "   ",
        "   "
      ],
      "nodes": [
        {
          "content": "private String accessToken;",
          "pos": [
            0,
            27
          ]
        },
        {
          "content": "private String mySiteApiPath;",
          "pos": [
            33,
            62
          ]
        },
        {
          "content": "private String clientId;",
          "pos": [
            68,
            92
          ]
        },
        {
          "content": "private String clientSecret;",
          "pos": [
            98,
            126
          ]
        },
        {
          "content": "private String sharepointURL;",
          "pos": [
            132,
            161
          ]
        },
        {
          "content": "private String authority;",
          "pos": [
            167,
            192
          ]
        },
        {
          "content": "private const string getFilesPath = \"/getfolderbyserverrelativeurl('Documents')/Files\";",
          "pos": [
            198,
            285
          ]
        }
      ]
    },
    {
      "pos": [
        5103,
        5548
      ],
      "content": "public static async Task<SharePointUploadContext> createContext(ServiceUser user, ServiceSettingsDictionary settings)\n     {\n         //Get the current access token\n         AzureActiveDirectoryCredentials creds = (await user.GetIdentitiesAsync()).OfType<AzureActiveDirectoryCredentials>().FirstOrDefault();\n         string userToken = creds.AccessToken;\n         return new SharePointUploadContext(userToken, settings);\n     }",
      "leadings": [
        "",
        "   ",
        "   ",
        "   ",
        "   ",
        "   ",
        "   "
      ],
      "nodes": [
        {
          "content": "public static async Task",
          "pos": [
            0,
            24
          ]
        },
        {
          "content": "createContext(ServiceUser user, ServiceSettingsDictionary settings)",
          "pos": [
            50,
            117
          ]
        },
        {
          "content": "{",
          "pos": [
            123,
            124
          ]
        },
        {
          "content": "//Get the current access token",
          "pos": [
            134,
            164
          ]
        },
        {
          "content": "AzureActiveDirectoryCredentials creds = (await user.GetIdentitiesAsync()).OfType",
          "pos": [
            174,
            254
          ]
        },
        {
          "content": "().FirstOrDefault();",
          "pos": [
            287,
            307
          ]
        },
        {
          "content": "string userToken = creds.AccessToken;",
          "pos": [
            317,
            354
          ]
        },
        {
          "content": "return new SharePointUploadContext(userToken, settings);",
          "pos": [
            364,
            420
          ]
        },
        {
          "content": "}",
          "pos": [
            426,
            427
          ]
        }
      ]
    },
    {
      "pos": [
        5558,
        6375
      ],
      "content": "private SharePointUploadContext(string userToken, ServiceSettingsDictionary settings)\n     {\n         //Call ADAL and request a token to SharePoint with the access token\n         AuthenticationContext ac = new AuthenticationContext(authority);\n         AuthenticationResult ar = ac.AcquireToken(sharepointURL, new ClientCredential(clientId, clientSecret), new UserAssertion(userToken));\n         accessToken = ar.AccessToken;\n         string upn = ar.UserInfo.UserId;\n         mySiteApiPath = \"/personal/\" + upn.Replace('@','_').Replace('.','_') + \"/_api/web\";\n         clientId = settings.AzureActiveDirectoryClientId;\n         clientSecret = settings[\"SP_ClientSecret\"];\n         sharepointURL = settings[\"SP_SharePointURL\"];\n         authority = settings[\"SP_Authority\"];\n     }",
      "leadings": [
        "",
        "   ",
        "   ",
        "   ",
        "   ",
        "   ",
        "   ",
        "   ",
        "   ",
        "   ",
        "   ",
        "   ",
        "   "
      ],
      "nodes": [
        {
          "content": "private SharePointUploadContext(string userToken, ServiceSettingsDictionary settings)",
          "pos": [
            0,
            85
          ]
        },
        {
          "content": "{",
          "pos": [
            91,
            92
          ]
        },
        {
          "content": "//Call ADAL and request a token to SharePoint with the access token",
          "pos": [
            102,
            169
          ]
        },
        {
          "content": "AuthenticationContext ac = new AuthenticationContext(authority);",
          "pos": [
            179,
            243
          ]
        },
        {
          "content": "AuthenticationResult ar = ac.AcquireToken(sharepointURL, new ClientCredential(clientId, clientSecret), new UserAssertion(userToken));",
          "pos": [
            253,
            386
          ]
        },
        {
          "content": "accessToken = ar.AccessToken;",
          "pos": [
            396,
            425
          ]
        },
        {
          "content": "string upn = ar.UserInfo.UserId;",
          "pos": [
            435,
            467
          ]
        },
        {
          "content": "mySiteApiPath = \"/personal/\" + upn.Replace('@','<bpt id=\"p1\">_</bpt>').Replace('.','<ept id=\"p1\">_</ept>') + \"/_api/web\";",
          "pos": [
            477,
            560
          ]
        },
        {
          "content": "clientId = settings.AzureActiveDirectoryClientId;",
          "pos": [
            570,
            619
          ]
        },
        {
          "content": "clientSecret = settings[\"SP_ClientSecret\"];",
          "pos": [
            629,
            672
          ]
        },
        {
          "content": "sharepointURL = settings[\"SP_SharePointURL\"];",
          "pos": [
            682,
            727
          ]
        },
        {
          "content": "authority = settings[\"SP_Authority\"];",
          "pos": [
            737,
            774
          ]
        },
        {
          "content": "}",
          "pos": [
            780,
            781
          ]
        }
      ]
    },
    {
      "content": "Now create a method to add the file to the user's document library:",
      "pos": [
        6380,
        6447
      ]
    },
    {
      "pos": [
        6457,
        7704
      ],
      "content": "public async Task<bool> UploadDocument(string docName, byte[] document)\n     {\n         string uploadUri = sharepointURL + mySiteApiPath + getFilesPath + string.Format(@\"/Add(url='{0}.docx', overwrite=true)\", docName);\n         using (HttpClient client = new HttpClient())\n         {\n             Func<HttpRequestMessage> requestCreator = () =>\n             {\n                 HttpRequestMessage UploadRequest = new HttpRequestMessage(HttpMethod.Post, uploadUri);\n                 UploadRequest.Content = new System.Net.Http.ByteArrayContent(document);\n                 UploadRequest.Content.Headers.ContentType = new MediaTypeHeaderValue(\"application/json\");\n                 UploadRequest.Content.Headers.ContentType.Parameters.Add(new NameValueHeaderValue(\"odata\", \"verbose\"));\n                 return UploadRequest;\n             };\n             using (HttpRequestMessage uploadRequest = requestCreator.Invoke())\n             {\n                 uploadRequest.Headers.Authorization = new AuthenticationHeaderValue(\"Bearer\", accessToken);\n                 HttpResponseMessage uploadResponse = await client.SendAsync(uploadRequest);\n             }\n         }\n         return true;\n     }",
      "leadings": [
        "",
        "   ",
        "   ",
        "   ",
        "   ",
        "   ",
        "   ",
        "   ",
        "   ",
        "   ",
        "   ",
        "   ",
        "   ",
        "   ",
        "   ",
        "   ",
        "   ",
        "   ",
        "   ",
        "   ",
        "   "
      ],
      "nodes": [
        {
          "content": "public async Task",
          "pos": [
            0,
            17
          ]
        },
        {
          "content": "UploadDocument(string docName, byte[] document)",
          "pos": [
            24,
            71
          ]
        },
        {
          "content": "{",
          "pos": [
            77,
            78
          ]
        },
        {
          "content": "string uploadUri = sharepointURL + mySiteApiPath + getFilesPath + string.Format(@\"/Add(url='{0}.docx', overwrite=true)\", docName);",
          "pos": [
            88,
            218
          ]
        },
        {
          "content": "using (HttpClient client = new HttpClient())",
          "pos": [
            228,
            272
          ]
        },
        {
          "content": "{",
          "pos": [
            282,
            283
          ]
        },
        {
          "content": "Func",
          "pos": [
            297,
            301
          ]
        },
        {
          "content": "requestCreator = () =&gt;",
          "pos": [
            322,
            344
          ]
        },
        {
          "content": "{",
          "pos": [
            358,
            359
          ]
        },
        {
          "content": "HttpRequestMessage UploadRequest = new HttpRequestMessage(HttpMethod.Post, uploadUri);",
          "pos": [
            377,
            463
          ]
        },
        {
          "content": "UploadRequest.Content = new System.Net.Http.ByteArrayContent(document);",
          "pos": [
            481,
            552
          ]
        },
        {
          "content": "UploadRequest.Content.Headers.ContentType = new MediaTypeHeaderValue(\"application/json\");",
          "pos": [
            570,
            659
          ]
        },
        {
          "content": "UploadRequest.Content.Headers.ContentType.Parameters.Add(new NameValueHeaderValue(\"odata\", \"verbose\"));",
          "pos": [
            677,
            780
          ]
        },
        {
          "content": "return UploadRequest;",
          "pos": [
            798,
            819
          ]
        },
        {
          "content": "};",
          "pos": [
            833,
            835
          ]
        },
        {
          "content": "using (HttpRequestMessage uploadRequest = requestCreator.Invoke())",
          "pos": [
            849,
            915
          ]
        },
        {
          "content": "{",
          "pos": [
            929,
            930
          ]
        },
        {
          "content": "uploadRequest.Headers.Authorization = new AuthenticationHeaderValue(\"Bearer\", accessToken);",
          "pos": [
            948,
            1039
          ]
        },
        {
          "content": "HttpResponseMessage uploadResponse = await client.SendAsync(uploadRequest);",
          "pos": [
            1057,
            1132
          ]
        },
        {
          "content": "}",
          "pos": [
            1146,
            1147
          ]
        },
        {
          "content": "}",
          "pos": [
            1157,
            1158
          ]
        },
        {
          "content": "return true;",
          "pos": [
            1168,
            1180
          ]
        },
        {
          "content": "}",
          "pos": [
            1186,
            1187
          ]
        }
      ]
    },
    {
      "content": "Create and upload a Word document",
      "pos": [
        7739,
        7772
      ]
    },
    {
      "content": "To create a Word document, you'll use the OpenXML NuGet package.",
      "pos": [
        7774,
        7838
      ]
    },
    {
      "content": "Install this package by opening the NuGet Manager and searching for DocumentFormat.OpenXml.",
      "pos": [
        7839,
        7930
      ]
    },
    {
      "content": "Add the following code to TodoItemController.",
      "pos": [
        7935,
        7980
      ]
    },
    {
      "content": "This creates a Word document based on a TodoItem.",
      "pos": [
        7981,
        8030
      ]
    },
    {
      "content": "The text of the document will be the name of the item.",
      "pos": [
        8031,
        8085
      ]
    },
    {
      "pos": [
        8095,
        9165
      ],
      "content": "private static byte[] CreateWordDocument(TodoItem todoItem)\n     {\n         byte[] document;\n         using (MemoryStream generatedDocument = new MemoryStream())\n         {\n             using (WordprocessingDocument package = WordprocessingDocument.Create(generatedDocument, WordprocessingDocumentType.Document))\n             {\n                 MainDocumentPart mainPart = package.MainDocumentPart;\n                 if (mainPart == null)\n                 {\n                     mainPart = package.AddMainDocumentPart();\n                     new Document(new Body()).Save(mainPart);\n                 }\n                 Body body = mainPart.Document.Body;\n                 Paragraph p =\n                     new Paragraph(\n                         new Run(\n                             new Text(todoItem.Text)));\n                 body.Append(p);\n                 mainPart.Document.Save();\n             }\n             document = generatedDocument.ToArray();\n         }\n         return document;\n     }",
      "leadings": [
        "",
        "   ",
        "   ",
        "   ",
        "   ",
        "   ",
        "   ",
        "   ",
        "   ",
        "   ",
        "   ",
        "   ",
        "   ",
        "   ",
        "   ",
        "   ",
        "   ",
        "   ",
        "   ",
        "   ",
        "   ",
        "   ",
        "   ",
        "   ",
        "   "
      ],
      "nodes": [
        {
          "content": "private static byte[] CreateWordDocument(TodoItem todoItem)",
          "pos": [
            0,
            59
          ]
        },
        {
          "content": "{",
          "pos": [
            65,
            66
          ]
        },
        {
          "content": "byte[] document;",
          "pos": [
            76,
            92
          ]
        },
        {
          "content": "using (MemoryStream generatedDocument = new MemoryStream())",
          "pos": [
            102,
            161
          ]
        },
        {
          "content": "{",
          "pos": [
            171,
            172
          ]
        },
        {
          "content": "using (WordprocessingDocument package = WordprocessingDocument.Create(generatedDocument, WordprocessingDocumentType.Document))",
          "pos": [
            186,
            312
          ]
        },
        {
          "content": "{",
          "pos": [
            326,
            327
          ]
        },
        {
          "content": "MainDocumentPart mainPart = package.MainDocumentPart;",
          "pos": [
            345,
            398
          ]
        },
        {
          "content": "if (mainPart == null)",
          "pos": [
            416,
            437
          ]
        },
        {
          "content": "{",
          "pos": [
            455,
            456
          ]
        },
        {
          "content": "mainPart = package.AddMainDocumentPart();",
          "pos": [
            478,
            519
          ]
        },
        {
          "content": "new Document(new Body()).Save(mainPart);",
          "pos": [
            541,
            581
          ]
        },
        {
          "content": "}",
          "pos": [
            599,
            600
          ]
        },
        {
          "content": "Body body = mainPart.Document.Body;",
          "pos": [
            618,
            653
          ]
        },
        {
          "content": "Paragraph p =",
          "pos": [
            671,
            684
          ]
        },
        {
          "content": "new Paragraph(",
          "pos": [
            706,
            720
          ]
        },
        {
          "content": "new Run(",
          "pos": [
            746,
            754
          ]
        },
        {
          "content": "new Text(todoItem.Text)));",
          "pos": [
            784,
            810
          ]
        },
        {
          "content": "body.Append(p);",
          "pos": [
            828,
            843
          ]
        },
        {
          "content": "mainPart.Document.Save();",
          "pos": [
            861,
            886
          ]
        },
        {
          "content": "}",
          "pos": [
            900,
            901
          ]
        },
        {
          "content": "document = generatedDocument.ToArray();",
          "pos": [
            915,
            954
          ]
        },
        {
          "content": "}",
          "pos": [
            964,
            965
          ]
        },
        {
          "content": "return document;",
          "pos": [
            975,
            991
          ]
        },
        {
          "content": "}",
          "pos": [
            997,
            998
          ]
        }
      ]
    },
    {
      "content": "Replace PostTodoItem with the following:",
      "pos": [
        9170,
        9210
      ]
    },
    {
      "pos": [
        9220,
        9350
      ],
      "content": "public async Task<IHttpActionResult> PostTodoItem(TodoItem item)\n     {\n         TodoItem current = await InsertAsync(item);",
      "leadings": [
        "",
        "   ",
        "   "
      ],
      "nodes": [
        {
          "content": "public async Task",
          "pos": [
            0,
            17
          ]
        },
        {
          "content": "PostTodoItem(TodoItem item)",
          "pos": [
            37,
            64
          ]
        },
        {
          "content": "{",
          "pos": [
            70,
            71
          ]
        },
        {
          "content": "TodoItem current = await InsertAsync(item);",
          "pos": [
            81,
            124
          ]
        }
      ]
    },
    {
      "pos": [
        9364,
        9622
      ],
      "content": "SharePointUploadContext context = await SharePointUploadContext.createContext((ServiceUser)this.User, Services.Settings);\n         byte[] document = CreateWordDocument(item);\n         bool uploadResult = await context.UploadDocument(item.Id, document);",
      "leadings": [
        "",
        "   ",
        "   "
      ],
      "nodes": [
        {
          "content": "SharePointUploadContext context = await SharePointUploadContext.createContext((ServiceUser)this.User, Services.Settings);",
          "pos": [
            0,
            121
          ]
        },
        {
          "content": "byte[] document = CreateWordDocument(item);",
          "pos": [
            131,
            174
          ]
        },
        {
          "content": "bool uploadResult = await context.UploadDocument(item.Id, document);",
          "pos": [
            184,
            252
          ]
        }
      ]
    },
    {
      "pos": [
        9636,
        9712
      ],
      "content": "return CreatedAtRoute(\"Tables\", new { id = current.Id }, current);\n     }",
      "leadings": [
        "",
        "   "
      ],
      "nodes": [
        {
          "content": "return CreatedAtRoute(\"Tables\", new { id = current.Id }, current);",
          "pos": [
            0,
            66
          ]
        },
        {
          "content": "}",
          "pos": [
            72,
            73
          ]
        }
      ]
    },
    {
      "content": "Test the application",
      "pos": [
        9748,
        9768
      ]
    },
    {
      "content": "Publish the changes to the backend, and then run your client application.",
      "pos": [
        9773,
        9846
      ]
    },
    {
      "content": "Log in when prompted, and insert a new TodoItem.",
      "pos": [
        9847,
        9895
      ]
    },
    {
      "content": "Navigate to your SharePoint site and log in with the same user.",
      "pos": [
        9900,
        9963
      ]
    },
    {
      "content": "Select the OneDrive tab.",
      "pos": [
        9968,
        9992
      ]
    },
    {
      "content": "Under the Documents Folder, you should see a Word document with a GUID title.",
      "pos": [
        9993,
        10070
      ]
    },
    {
      "content": "When you open it, you should find the text for your TodoItem.",
      "pos": [
        10071,
        10132
      ]
    },
    {
      "content": "test",
      "pos": [
        10734,
        10738
      ]
    }
  ],
  "content": "<properties\n    pageTitle=\"Connect a Mobile App to an enterprise SaaS | Microsoft Azure\"\n    description=\"Learn how to make calls to enterprise resources such as SharePoint Online\"\n    documentationCenter=\"\"\n    authors=\"mattchenderson\"\n    manager=\"dwrede\"\n    editor=\"na\"\n    services=\"app-service\\mobile\"/>\n\n<tags\n    ms.service=\"app-service-mobile\"\n    ms.workload=\"mobile\"\n    ms.tgt_pltfrm=\"na\"\n    ms.devlang=\"multiple\"\n    ms.topic=\"get-started-article\"\n    ms.date=\"06/19/2015\"\n    ms.author=\"mahender\"/>\n\n# Connect your mobile app to SaaS APIs\n\nIn this tutorial, you will connect your mobile app to an enterprise software-as-a-service (SaaS) solution. You will update the app from the [Authenticate your app with Azure Active Directory Authentication Library Single Sign-On] to create a Microsoft Word document in SharePoint Online whenever a new TodoItem is added.\n\nThis tutorial requires the following:\n\n* Visual Studio 2013 running on Windows 8.1\n* An active [SharePoint Online] subscription\n* Completion of the [Authenticate your app with Active Directory Authentication Library Single Sign-On] tutorial. You should use the tenant provided by your SharePoint subscription.\n\n## <a name=\"configure-permissions\"></a>Configure your application for delegated access to SharePoint\nBy default, the token you receive from AAD has limited permissions. In order to access a third-party resource or SaaS application such as SharePoint Online, you must explicitly allow it.\n\n1. In the **Active Directory** Section of the [Azure Management Portal], select your tenant. Navigate to the web application that you created for the App Service.\n\n2. In the **Configure** tab, scroll the page down to the permissions to other applications section. Select **Office 365 SharePoint Online** and grant the **Edit or delete users' files** delegated permission. Then click **Save**.\n\n    ![][1]\n\nYou have now configured Azure AD to issue a SharePoint access token to the App Service.\n\n## <a name=\"store-credentials\"></a>Add SharePoint information to your Mobile App\n\nIn order to make a call to SharePoint, you need to specify the endpoints that the mobile app needs to talk to. You also need to be able to prove the identity of your app service. This is accomplished using a Client ID and Client Secret pair. You have already obtained and stored the Client ID for the app service during the AAD login setup. Because these are sensitive credentials, you should'nt store them as plaintext in our code. Instead, you'll set these values as Application Settings for our Mobile App Code site.\n\n1. Return to the AAD Applications tab for your tenant, and select the web application for your app service.\n\n2. Under Configure, scroll down to Keys. You'll obtain a Client Secret by generating a new key. Note once you create a key and leave the page, there is no way to get it out of the portal again. Upon creation you must copy and save this value in a secure location. Select a duration for your key, then click save, and copy out the resulting value.\n\n3. In the Mobile App Code section of the Management Portal, navigate to the Configure tab, and scroll down to App Settings. Here you can provide a key-value pair to help you reference the necessary credentials.\n\n* Set SP_Authority to be the authority endpoint for your AAD tenant. This should be the same as the authority value used for your client app. It'll be of the form `https://login.windows.net/contoso.onmicrosoft.com`\n\n* Set SP_ClientSecret to be the client secret value you obtained earlier.\n\n* Set SP_SharePointURL to be the URL for your SharePoint site. It should be of the form `https://contoso-my.sharepoint.com`\n\nYou'll be able to obtain these values again in your code using ApiServices.Settings.\n\n## <a name=\"obtain-token\"></a>Obtain an access token and call the SharePoint API\n\nIn order to access SharePoint, you need a special access token with SharePoint as the target audience. To get this token, you'll need to call back into Azure AD with the identity of the App Service and the token that was issued for the user.\n\n1. Open your Mobile App Code project in Visual Studio.\n\n[AZURE.INCLUDE [app-service-mobile-dotnet-adal-install-nuget](../../includes/app-service-mobile-dotnet-adal-install-nuget.md)]\n\n2. In the NuGet Package manager, click **Online**. Enter **Microsoft.Azure.Mobile.Server.AppService** as a search term. Then click **Install** to install the [Mobile Apps .NET Backend App Service Extension] package. This package provides extension methods for working with information about the currently logged-in user.\n\n2. In your Mobile App Code project, create a new class called SharePointUploadContext. Add a `using Microsoft.Azure.Mobile.Server.AppService;` statement to the file. Then, add the following to the class:\n\n        private String accessToken;\n        private String mySiteApiPath;\n        private String clientId;\n        private String clientSecret;\n        private String sharepointURL;\n        private String authority;\n        private const string getFilesPath = \"/getfolderbyserverrelativeurl('Documents')/Files\";\n\n        public static async Task<SharePointUploadContext> createContext(ServiceUser user, ServiceSettingsDictionary settings)\n        {\n            //Get the current access token\n            AzureActiveDirectoryCredentials creds = (await user.GetIdentitiesAsync()).OfType<AzureActiveDirectoryCredentials>().FirstOrDefault();\n            string userToken = creds.AccessToken;\n            return new SharePointUploadContext(userToken, settings);\n        }\n\n        private SharePointUploadContext(string userToken, ServiceSettingsDictionary settings)\n        {\n            //Call ADAL and request a token to SharePoint with the access token\n            AuthenticationContext ac = new AuthenticationContext(authority);\n            AuthenticationResult ar = ac.AcquireToken(sharepointURL, new ClientCredential(clientId, clientSecret), new UserAssertion(userToken));\n            accessToken = ar.AccessToken;\n            string upn = ar.UserInfo.UserId;\n            mySiteApiPath = \"/personal/\" + upn.Replace('@','_').Replace('.','_') + \"/_api/web\";\n            clientId = settings.AzureActiveDirectoryClientId;\n            clientSecret = settings[\"SP_ClientSecret\"];\n            sharepointURL = settings[\"SP_SharePointURL\"];\n            authority = settings[\"SP_Authority\"];\n        }\n\n3. Now create a method to add the file to the user's document library:\n\n        public async Task<bool> UploadDocument(string docName, byte[] document)\n        {\n            string uploadUri = sharepointURL + mySiteApiPath + getFilesPath + string.Format(@\"/Add(url='{0}.docx', overwrite=true)\", docName);\n            using (HttpClient client = new HttpClient())\n            {\n                Func<HttpRequestMessage> requestCreator = () =>\n                {\n                    HttpRequestMessage UploadRequest = new HttpRequestMessage(HttpMethod.Post, uploadUri);\n                    UploadRequest.Content = new System.Net.Http.ByteArrayContent(document);\n                    UploadRequest.Content.Headers.ContentType = new MediaTypeHeaderValue(\"application/json\");\n                    UploadRequest.Content.Headers.ContentType.Parameters.Add(new NameValueHeaderValue(\"odata\", \"verbose\"));\n                    return UploadRequest;\n                };\n                using (HttpRequestMessage uploadRequest = requestCreator.Invoke())\n                {\n                    uploadRequest.Headers.Authorization = new AuthenticationHeaderValue(\"Bearer\", accessToken);\n                    HttpResponseMessage uploadResponse = await client.SendAsync(uploadRequest);\n                }\n            }\n            return true;\n        }\n\n## <a name=\"create-document\"></a>Create and upload a Word document\n\nTo create a Word document, you'll use the OpenXML NuGet package. Install this package by opening the NuGet Manager and searching for DocumentFormat.OpenXml.\n\n1. Add the following code to TodoItemController. This creates a Word document based on a TodoItem. The text of the document will be the name of the item.\n\n        private static byte[] CreateWordDocument(TodoItem todoItem)\n        {\n            byte[] document;\n            using (MemoryStream generatedDocument = new MemoryStream())\n            {\n                using (WordprocessingDocument package = WordprocessingDocument.Create(generatedDocument, WordprocessingDocumentType.Document))\n                {\n                    MainDocumentPart mainPart = package.MainDocumentPart;\n                    if (mainPart == null)\n                    {\n                        mainPart = package.AddMainDocumentPart();\n                        new Document(new Body()).Save(mainPart);\n                    }\n                    Body body = mainPart.Document.Body;\n                    Paragraph p =\n                        new Paragraph(\n                            new Run(\n                                new Text(todoItem.Text)));\n                    body.Append(p);\n                    mainPart.Document.Save();\n                }\n                document = generatedDocument.ToArray();\n            }\n            return document;\n        }\n\n2. Replace PostTodoItem with the following:\n\n        public async Task<IHttpActionResult> PostTodoItem(TodoItem item)\n        {\n            TodoItem current = await InsertAsync(item);\n\n            SharePointUploadContext context = await SharePointUploadContext.createContext((ServiceUser)this.User, Services.Settings);\n            byte[] document = CreateWordDocument(item);\n            bool uploadResult = await context.UploadDocument(item.Id, document);\n\n            return CreatedAtRoute(\"Tables\", new { id = current.Id }, current);\n        }\n\n## <a name=\"test-application\"></a>Test the application\n\n1. Publish the changes to the backend, and then run your client application. Log in when prompted, and insert a new TodoItem.\n\n2. Navigate to your SharePoint site and log in with the same user.\n\n3. Select the OneDrive tab. Under the Documents Folder, you should see a Word document with a GUID title. When you open it, you should find the text for your TodoItem.\n\n<!-- Images. -->\n\n[1]: ./media/app-service-mobile-dotnet-backend-get-started-connect-to-enterprise/aad-sharepoint-permissions.png\n\n<!-- URLs. -->\n\n[Preview Azure Management Portal]: https://portal.azure.com/\n[Azure Management Portal]: https://manage.windowsazure.com/\n[SharePoint Online]: http://office.microsoft.com/en-us/sharepoint/\n[Authenticate your app with Active Directory Authentication Library Single Sign-On]: app-service-mobile-dotnet-backend-ios-aad-sso-preview.md\n[Mobile Apps .NET Backend App Service Extension]: http://www.nuget.org/packages/Microsoft.Azure.Mobile.Server.AppService/\n\ntest\n"
}