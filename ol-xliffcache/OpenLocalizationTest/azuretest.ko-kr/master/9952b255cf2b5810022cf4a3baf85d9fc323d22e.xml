{
  "nodes": [
    {
      "content": "Send cross-platform notifications to a specific user in iOS",
      "pos": [
        28,
        87
      ]
    },
    {
      "content": "Learn how to send push notifications to all devices of a specific user.",
      "pos": [
        107,
        178
      ]
    },
    {
      "content": "Send cross-platform notifications to a specific user",
      "pos": [
        516,
        568
      ]
    },
    {
      "content": "&amp;nbsp;",
      "pos": [
        701,
        707
      ]
    },
    {
      "content": "This topic shows you how to send notifications to all registered devices of a specific user from your mobile backend.",
      "pos": [
        844,
        961
      ]
    },
    {
      "content": "It introduced the concept of [templates], which gives client applications the freedom of specifying payload formats and variable placeholders at registration.",
      "pos": [
        962,
        1120
      ]
    },
    {
      "content": "Send then hits every platform with these placeholders, enabling cross-platform notifications.",
      "pos": [
        1121,
        1214
      ]
    },
    {
      "content": "<ph id=\"ph1\">[AZURE.NOTE]</ph> To get push working with cross-platform clients, you will need to complete this tutorial for each platform you would like to enable.",
      "pos": [
        1218,
        1363
      ]
    },
    {
      "content": "You will only need to do the <bpt id=\"p1\">[</bpt>mobile backend update<ept id=\"p1\">](#backend)</ept> once for clients that share the same mobile backend.",
      "pos": [
        1364,
        1479
      ]
    },
    {
      "content": "Prerequisites",
      "pos": [
        1484,
        1497
      ]
    },
    {
      "content": "Before you start this tutorial, you must have already completed these App Service tutorials for each client platform you want working:",
      "pos": [
        1500,
        1634
      ]
    },
    {
      "content": "[Get started with authentication]",
      "pos": [
        1638,
        1671
      ]
    },
    {
      "content": "Adds a login requirement to the TodoList sample app.",
      "pos": [
        1676,
        1728
      ]
    },
    {
      "content": "[Get started with push notifications]",
      "pos": [
        1732,
        1769
      ]
    },
    {
      "content": "Configures the TodoList sample app for push notifications.",
      "pos": [
        1774,
        1832
      ]
    },
    {
      "content": "Update your client to register for templates to handle cross-platform pushes",
      "pos": [
        1857,
        1933
      ]
    },
    {
      "pos": [
        1938,
        2161
      ],
      "content": "Move the APNs registration snippets in <bpt id=\"p1\">**</bpt>QSAppDelegate.m<ept id=\"p1\">**</ept>'s <bpt id=\"p2\">**</bpt>application:didFinishLaunchingWithOptions<ept id=\"p2\">**</ept> to the call to <bpt id=\"p3\">**</bpt>loginWithProvider<ept id=\"p3\">**</ept> in <bpt id=\"p4\">**</bpt>QSTodoListViewController.m<ept id=\"p4\">**</ept> so it happens after authentication completes:"
    },
    {
      "pos": [
        2171,
        2310
      ],
      "content": "[client loginWithProvider:@\"facebook\" controller:self animated:YES completion:^(MSUser *user, NSError *error) {\n         [self refresh];",
      "leadings": [
        "",
        "   "
      ],
      "nodes": [
        {
          "content": "[client loginWithProvider:@\"facebook\" controller:self animated:YES completion:^(MSUser *user, NSError *error) {",
          "pos": [
            0,
            111
          ]
        },
        {
          "content": "[self refresh];",
          "pos": [
            121,
            136
          ]
        }
      ]
    },
    {
      "pos": [
        2336,
        3005
      ],
      "content": "// register iOS8 or previous devices for notifications\n         if ([[UIApplication sharedApplication] respondsToSelector:@selector(registerUserNotificationSettings:)] && [[UIApplication sharedApplication] respondsToSelector:@selector(registerForRemoteNotifications)]) {\n             [[UIApplication sharedApplication] registerForRemoteNotifications];\n         }\n         else {\n             // Register for remote notifications\n             [[UIApplication sharedApplication] registerForRemoteNotificationTypes:\n              UIRemoteNotificationTypeAlert | UIRemoteNotificationTypeBadge | UIRemoteNotificationTypeSound];\n         }\n     }];",
      "leadings": [
        "",
        "   ",
        "   ",
        "   ",
        "   ",
        "   ",
        "   ",
        "   ",
        "   ",
        "   "
      ],
      "nodes": [
        {
          "content": "// register iOS8 or previous devices for notifications",
          "pos": [
            0,
            54
          ]
        },
        {
          "content": "if ([[UIApplication sharedApplication] respondsToSelector:@selector(registerUserNotificationSettings:)] &amp;&amp; [[UIApplication sharedApplication] respondsToSelector:@selector(registerForRemoteNotifications)]) {",
          "pos": [
            64,
            270
          ]
        },
        {
          "content": "[[UIApplication sharedApplication] registerForRemoteNotifications];",
          "pos": [
            284,
            351
          ]
        },
        {
          "content": "}",
          "pos": [
            361,
            362
          ]
        },
        {
          "content": "else {",
          "pos": [
            372,
            378
          ]
        },
        {
          "content": "// Register for remote notifications",
          "pos": [
            392,
            428
          ]
        },
        {
          "content": "[[UIApplication sharedApplication] registerForRemoteNotificationTypes:",
          "pos": [
            442,
            512
          ]
        },
        {
          "content": "UIRemoteNotificationTypeAlert | UIRemoteNotificationTypeBadge | UIRemoteNotificationTypeSound];",
          "pos": [
            527,
            622
          ]
        },
        {
          "content": "}",
          "pos": [
            632,
            633
          ]
        },
        {
          "content": "}];",
          "pos": [
            639,
            642
          ]
        }
      ]
    },
    {
      "pos": [
        3010,
        3162
      ],
      "content": "Replace your <bpt id=\"p1\">**</bpt>registerDeviceToken<ept id=\"p1\">**</ept> call in <bpt id=\"p2\">**</bpt>application:didRegisterForRemoteNotificationsWithDeviceToken<ept id=\"p2\">**</ept> with the following to work with templates:"
    },
    {
      "pos": [
        3172,
        3352
      ],
      "content": "NSDictionary *templates = @{\n                            @\"testNotificationTemplate\": @{ @\"body\" : @{ @\"aps\" : @{ @\"alert\": @\"$(message)\" } } }\n                            };",
      "leadings": [
        "",
        "   ",
        "   "
      ],
      "nodes": [
        {
          "content": "NSDictionary *templates = @{",
          "pos": [
            0,
            28
          ]
        },
        {
          "content": "@\"testNotificationTemplate\": @{ @\"body\" : @{ @\"aps\" : @{ @\"alert\": @\"$(message)\" } } }",
          "pos": [
            57,
            143
          ]
        },
        {
          "content": "};",
          "pos": [
            172,
            174
          ]
        }
      ]
    },
    {
      "pos": [
        3366,
        3627
      ],
      "content": "// register with templates\n     [client.push registerDeviceToken:deviceToken template:templates completion:^(NSError *error) {\n         if (error != nil) {\n             NSLog(@\"Error registering for notifications: %@\", error);\n         }\n     }];",
      "leadings": [
        "",
        "   ",
        "   ",
        "   ",
        "   ",
        "   "
      ],
      "nodes": [
        {
          "content": "// register with templates",
          "pos": [
            0,
            26
          ]
        },
        {
          "content": "[client.push registerDeviceToken:deviceToken template:templates completion:^(NSError *error) {",
          "pos": [
            32,
            126
          ]
        },
        {
          "content": "if (error != nil) {",
          "pos": [
            136,
            155
          ]
        },
        {
          "content": "NSLog(@\"Error registering for notifications: %@\", error);",
          "pos": [
            169,
            226
          ]
        },
        {
          "content": "}",
          "pos": [
            236,
            237
          ]
        },
        {
          "content": "}];",
          "pos": [
            243,
            246
          ]
        }
      ]
    },
    {
      "content": "Update your service backend to send notifications to a specific user",
      "pos": [
        3653,
        3721
      ]
    },
    {
      "pos": [
        3726,
        3812
      ],
      "content": "In Visual Studio, update the <ph id=\"ph1\">`PostTodoItem`</ph> method definition with the following code:"
    },
    {
      "pos": [
        3824,
        3954
      ],
      "content": "public async Task<IHttpActionResult> PostTodoItem(TodoItem item)\n     {\n         TodoItem current = await InsertAsync(item);",
      "leadings": [
        "",
        "   ",
        "   "
      ],
      "nodes": [
        {
          "content": "public async Task",
          "pos": [
            0,
            17
          ]
        },
        {
          "content": "PostTodoItem(TodoItem item)",
          "pos": [
            37,
            64
          ]
        },
        {
          "content": "{",
          "pos": [
            70,
            71
          ]
        },
        {
          "content": "TodoItem current = await InsertAsync(item);",
          "pos": [
            81,
            124
          ]
        }
      ]
    },
    {
      "pos": [
        3968,
        4274
      ],
      "content": "// get notification hubs credentials associated with this mobile app\n         string notificationHubName = this.Services.Settings.NotificationHubName;\n         string notificationHubConnection = this.Services.Settings.Connections[ServiceSettingsKeys.NotificationHubConnectionString].ConnectionString;",
      "leadings": [
        "",
        "   ",
        "   "
      ],
      "nodes": [
        {
          "content": "// get notification hubs credentials associated with this mobile app",
          "pos": [
            0,
            68
          ]
        },
        {
          "content": "string notificationHubName = this.Services.Settings.NotificationHubName;",
          "pos": [
            78,
            150
          ]
        },
        {
          "content": "string notificationHubConnection = this.Services.Settings.Connections[ServiceSettingsKeys.NotificationHubConnectionString].ConnectionString;",
          "pos": [
            160,
            300
          ]
        }
      ]
    },
    {
      "pos": [
        4288,
        4461
      ],
      "content": "// connect to notification hub\n         NotificationHubClient Hub = NotificationHubClient.CreateClientFromConnectionString(notificationHubConnection, notificationHubName)",
      "leadings": [
        "",
        "   "
      ],
      "nodes": [
        {
          "content": "// connect to notification hub",
          "pos": [
            0,
            30
          ]
        },
        {
          "content": "NotificationHubClient Hub = NotificationHubClient.CreateClientFromConnectionString(notificationHubConnection, notificationHubName)",
          "pos": [
            40,
            170
          ]
        }
      ]
    },
    {
      "pos": [
        4475,
        4667
      ],
      "content": "// get the current user id and create tag to identify user\n         ServiceUser authenticatedUser = this.User as ServiceUser;\n         string userTag = \"_UserId:\" + authenticatedUser.Id;",
      "leadings": [
        "",
        "   ",
        "   "
      ],
      "nodes": [
        {
          "content": "// get the current user id and create tag to identify user",
          "pos": [
            0,
            58
          ]
        },
        {
          "content": "ServiceUser authenticatedUser = this.User as ServiceUser;",
          "pos": [
            68,
            125
          ]
        },
        {
          "content": "string userTag = \"_UserId:\" + authenticatedUser.Id;",
          "pos": [
            135,
            186
          ]
        }
      ]
    },
    {
      "pos": [
        4681,
        4800
      ],
      "content": "// build dictionary for template\n         var notification = new Dictionary<string, string>{{\"message\", item.Text}};",
      "leadings": [
        "",
        "   "
      ],
      "nodes": [
        {
          "content": "// build dictionary for template",
          "pos": [
            0,
            32
          ]
        },
        {
          "content": "var notification = new Dictionary&lt;string, string&gt;{{\"message\", item.Text}};",
          "pos": [
            42,
            116
          ]
        }
      ]
    },
    {
      "pos": [
        4814,
        5110
      ],
      "content": "try\n         {\n             await Hub.Push.SendTemplateNotificationAsync(notification, userTag);\n         }\n         catch (System.Exception ex)\n         {\n             throw;\n         }\n         return CreatedAtRoute(\"Tables\", new { id = current.Id }, current);\n     }",
      "leadings": [
        "",
        "   ",
        "   ",
        "   ",
        "   ",
        "   ",
        "   ",
        "   ",
        "   ",
        "   "
      ],
      "nodes": [
        {
          "content": "try",
          "pos": [
            0,
            3
          ]
        },
        {
          "content": "{",
          "pos": [
            13,
            14
          ]
        },
        {
          "content": "await Hub.Push.SendTemplateNotificationAsync(notification, userTag);",
          "pos": [
            28,
            96
          ]
        },
        {
          "content": "}",
          "pos": [
            106,
            107
          ]
        },
        {
          "content": "catch (System.Exception ex)",
          "pos": [
            117,
            144
          ]
        },
        {
          "content": "{",
          "pos": [
            154,
            155
          ]
        },
        {
          "content": "throw;",
          "pos": [
            169,
            175
          ]
        },
        {
          "content": "}",
          "pos": [
            185,
            186
          ]
        },
        {
          "content": "return CreatedAtRoute(\"Tables\", new { id = current.Id }, current);",
          "pos": [
            196,
            262
          ]
        },
        {
          "content": "}",
          "pos": [
            268,
            269
          ]
        }
      ]
    },
    {
      "content": "Test the app",
      "pos": [
        5133,
        5145
      ]
    },
    {
      "content": "Re-publish your mobile backend project and run any of the client apps you have set up.",
      "pos": [
        5147,
        5233
      ]
    },
    {
      "content": "On item insertion, the backend will send notifications to all client apps where the user is logged in.",
      "pos": [
        5234,
        5336
      ]
    },
    {
      "content": "test",
      "pos": [
        5629,
        5633
      ]
    }
  ],
  "content": "<properties \n    pageTitle=\"Send cross-platform notifications to a specific user in iOS\" \n    description=\"Learn how to send push notifications to all devices of a specific user.\"\n    services=\"app-service\\mobile\" \n    documentationCenter=\"ios\" \n    authors=\"ysxu\" \n    manager=\"dwrede\" \n    editor=\"\"/>\n\n<tags \n    ms.service=\"app-service-mobile\" \n    ms.workload=\"mobile\" \n    ms.tgt_pltfrm=\"mobile-dotnet\" \n    ms.devlang=\"objective-c\" \n    ms.topic=\"article\" \n    ms.date=\"06/23/2015\"\n    ms.author=\"yuaxu\"/>\n\n# Send cross-platform notifications to a specific user\n\n[AZURE.INCLUDE [app-service-mobile-selector-push-users-preview](../../includes/app-service-mobile-selector-push-users-preview.md)]\n&nbsp;  \n[AZURE.INCLUDE [app-service-mobile-note-mobile-services-preview](../../includes/app-service-mobile-note-mobile-services-preview.md)]\n\nThis topic shows you how to send notifications to all registered devices of a specific user from your mobile backend. It introduced the concept of [templates], which gives client applications the freedom of specifying payload formats and variable placeholders at registration. Send then hits every platform with these placeholders, enabling cross-platform notifications.\n\n> [AZURE.NOTE] To get push working with cross-platform clients, you will need to complete this tutorial for each platform you would like to enable. You will only need to do the [mobile backend update](#backend) once for clients that share the same mobile backend.\n \n##Prerequisites \n\nBefore you start this tutorial, you must have already completed these App Service tutorials for each client platform you want working:\n\n+ [Get started with authentication]<br/>Adds a login requirement to the TodoList sample app.\n\n+ [Get started with push notifications]<br/>Configures the TodoList sample app for push notifications.\n\n##<a name=\"client\"></a>Update your client to register for templates to handle cross-platform pushes\n\n1. Move the APNs registration snippets in **QSAppDelegate.m**'s **application:didFinishLaunchingWithOptions** to the call to **loginWithProvider** in **QSTodoListViewController.m** so it happens after authentication completes:\n\n        [client loginWithProvider:@\"facebook\" controller:self animated:YES completion:^(MSUser *user, NSError *error) {\n            [self refresh];\n            \n            // register iOS8 or previous devices for notifications\n            if ([[UIApplication sharedApplication] respondsToSelector:@selector(registerUserNotificationSettings:)] && [[UIApplication sharedApplication] respondsToSelector:@selector(registerForRemoteNotifications)]) {\n                [[UIApplication sharedApplication] registerForRemoteNotifications];\n            }\n            else {\n                // Register for remote notifications\n                [[UIApplication sharedApplication] registerForRemoteNotificationTypes:\n                 UIRemoteNotificationTypeAlert | UIRemoteNotificationTypeBadge | UIRemoteNotificationTypeSound];\n            }\n        }];\n\n2. Replace your **registerDeviceToken** call in **application:didRegisterForRemoteNotificationsWithDeviceToken** with the following to work with templates:\n\n        NSDictionary *templates = @{\n                               @\"testNotificationTemplate\": @{ @\"body\" : @{ @\"aps\" : @{ @\"alert\": @\"$(message)\" } } }\n                               };\n    \n        // register with templates\n        [client.push registerDeviceToken:deviceToken template:templates completion:^(NSError *error) {\n            if (error != nil) {\n                NSLog(@\"Error registering for notifications: %@\", error);\n            }\n        }];\n\n##<a name=\"backend\"></a>Update your service backend to send notifications to a specific user\n\n1. In Visual Studio, update the `PostTodoItem` method definition with the following code:  \n\n        public async Task<IHttpActionResult> PostTodoItem(TodoItem item)\n        {\n            TodoItem current = await InsertAsync(item);\n\n            // get notification hubs credentials associated with this mobile app\n            string notificationHubName = this.Services.Settings.NotificationHubName;\n            string notificationHubConnection = this.Services.Settings.Connections[ServiceSettingsKeys.NotificationHubConnectionString].ConnectionString;\n\n            // connect to notification hub\n            NotificationHubClient Hub = NotificationHubClient.CreateClientFromConnectionString(notificationHubConnection, notificationHubName)\n\n            // get the current user id and create tag to identify user\n            ServiceUser authenticatedUser = this.User as ServiceUser;\n            string userTag = \"_UserId:\" + authenticatedUser.Id;\n\n            // build dictionary for template\n            var notification = new Dictionary<string, string>{{\"message\", item.Text}};\n\n            try\n            {\n                await Hub.Push.SendTemplateNotificationAsync(notification, userTag);\n            }\n            catch (System.Exception ex)\n            {\n                throw;\n            }\n            return CreatedAtRoute(\"Tables\", new { id = current.Id }, current);\n        }\n\n##<a name=\"test\"></a>Test the app\n\nRe-publish your mobile backend project and run any of the client apps you have set up. On item insertion, the backend will send notifications to all client apps where the user is logged in.\n\n<!-- URLs. -->\n[Get started with authentication]: app-service-mobile-dotnet-backend-ios-get-started-push-preview.md\n[Get started with push notifications]: app-service-mobile-dotnet-backend-ios-get-started-push-preview.md\n[templates]: https://msdn.microsoft.com/en-us/library/dn530748.aspx\n \ntest\n"
}